# Supabase 프로젝트 연동

- https://supabase.com/
- `깃허브`로 회원가입 함.
- `New organization` 으로 프로젝트 생성 (아무것도 없을시 자동으로 생성창으로 넘어감)
- `데이터베이스 비밀번호`는 꼭 보관하자. (.env)
- 테이블 생성 (Table Editor 또는 SQL Editor)
- 기본형은 `Table Editor` 로 생성하고 추가적 설정은 `SQL Editor`
- 익숙하다면 `SQl Editor` 로 관리 권장. (ChatGPT 활용 권장)

## 1. todos 테이블 생성 쿼리

```sql
CREATE TABLE todos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR NOT NULL,
    completed BOOLEAN DEFAULT FALSE NOT NULL,
    content TEXT,
    updated_at TIMESTAMPTZ DEFAULT now(),
    created_at TIMESTAMPTZ DEFAULT now()
);
```

## 2. `.env` 파일 생성

- `VITE_` 를 접두어로 사용

```
VITE_SUPABASE_DB_PW=데이터베이스 비밀번호
VITE_SUPABASE_URL=URL값
VITE_SUPABASE_ANON_KEY=키값
```

- Supabase URL 과 Anon Key 파악하기
  - Project 선택 후 `Project Overview` 에서 확인
  - `Project API` 항목에서 파악 가능

## 3. Supabase 클라이언트 라이브러리 설치

```bash
npm install @supabase/supabase-js
```

## 4. 폴더 및 파일 구조

- `/src/lib 폴더` 생성
- `/src/lib/supabase.ts 파일` 생성

```ts
import { createClient } from '@supabase/supabase-js';

// CRA : process.env... 의 환경변수 호출과는 형식이 다름.
// Vite : import.meta.env... 환경변수 호출

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables');
}
// 웹브라우저 클라이언트 생성
export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

## 5. Supabase 의 테이블의 칼럼의 데이터 타입 정의

### 5.1. 데이터 타입 쉽게 추출하기

```bash
npx supabase login
```

- 향후 지시하는 대로 실행함.
- `id` 는 URL 의 앞쪽 단어가 ID가 됨.
  - id 는 Supabase URL 의 앞단어
  - 또는 메뉴로 진입시 `Project Settings` > `General settings`
- package.json 추가

```json
"generate-types": "npx supabase gen types typescript --project-id 프로젝트아이디 --schema 경로 > 파일명.ts"
```

- `scripts` 에 항목 장석(`npm run generate-types`)

```json
// 이 명령어를 주면 타입을 만들어 준다.
"scripts": {
    ...
    "generate-types": "npx supabase gen types typescript --project-id sbmtgbobratzifhqaeyk --schema public > types_db.ts"
  },
```

```bash
npm run generate-types
```

- `types_db.ts` 이 생성됨. (supabase에서 만든 타입을 가져온 것) 그대로 사용해도 괜찮지만, 관리하고있는 type 폴더안에 넣는 것도 좋다.

- 생성된 ts 의 내용을 참조해서 우리가 원하는 곳에 복사 및 붙여넣기 권장
  - 권장사항 : `/src/types/database.ts 생성 및 붙여넣기`
  - 편하게 활용하기 위한 처리

```ts
export type Todo = Database['public']['Tables']['todos']['Row'];
export type TodoInsert = Database['public']['Tables']['todos']['Insert'];
export type TodoUpdate = Database['public']['Tables']['todos']['Update'];
```

## 6. CRUD 실행해 보기

### 6.1. CRUD 를 위한 폴더 및 파일 구조

- https://supabase.com/docs/reference/javascript/start
- /src/apis 폴더 생성 또는 `/src/services 폴더` 생성
- 예) `/src/services 폴더`로 진행
- `/src/services/todoService.ts` 파일 생성
- 반드시 `async ... await` 활용(비동기)
- 반드시 함수 리턴타입 : `Promise<리턴 데이터타입>`
  - axios, fetch 등등...

```ts
import { supabase } from '../lib/supabase';
import type { Todo, TodoInsert, TodoUpdate } from '../types/TodoType';

// Todo 목록 조회
export const getTodos = async (): Promise<Todo[]> => {
  const { data, error } = await supabase
    .from('todos')
    .select('*')
    .order('created_at', { ascending: false });
  // 실행은 되었지만, 결과가 오류이다.
  if (error) {
    throw new Error(`getTodos 오류 : ${error.message}`);
  }
  return data || [];
};
// Todo 생성
export const createTodos = async (newTodo: TodoInsert): Promise<Todo | null> => {
  try {
    const { data, error } = await supabase
      .from('todos')
      .insert([{ ...newTodo, completed: false }])
      .select()
      .single();
    if (error) {
      throw new Error(`createTodos 오류 : ${error.message}`);
    }
    return data;
  } catch (error) {
    console.log(error);
    return null;
  }
};
// Todo 수정
export const updateTodos = async (id: number, editTitle: TodoUpdate): Promise<Todo | null> => {
  try {
    const { data, error } = await supabase
      .from('todos')
      .update({ ...editTitle, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select()
      .single();
    if (error) {
      throw new Error(`updateTodos 오류 : ${error.message}`);
    }
    return data;
  } catch (error) {
    console.log(error);
    return null;
  }
};
// Todo 삭제
export const deleteTodos = async (id: number): Promise<void> => {
  try {
    const { error } = await supabase.from('todos').delete().eq('id', id);
    if (error) {
      throw new Error(`deleteTodos 오류 : ${error.message}`);
    }
  } catch (error) {
    console.log(error);
  }
};
// completed toggle
export const toggleTodo = async (id: number, completed: boolean): Promise<Todo | null> => {
  return updateTodos(id, { completed });
};
```

## 7. todos 예제
